<!DOCTYPE html>
<html>
    <head>
        <title>My experiment</title>


       <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>


<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
        <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>

        <script>
          // Your web app's Firebase configuration
          var firebaseConfig = {
            apiKey: "AIzaSyD5QSdS9D_0B8v3KCi__wpWw7eXV-mml-4",
            authDomain: "mi-game2.firebaseapp.com",
            databaseURL: "https://mi-game2.firebaseio.com",
            projectId: "mi-game2",
            storageBucket: "mi-game2.appspot.com",
            messagingSenderId: "352593986583",
            appId: "1:352593986583:web:2b0d770e50a3c5c3c88852"
          };
          // Initialize Firebase
          firebase.initializeApp(firebaseConfig);
          var database = firebase.database();
        </script>


<!-- //        // Enable persistence
//        firebase.firestore().enablePersistence()
//            .catch(function(err) {
//            if (err.code == 'failed-precondition') {
//                // If multiple tabs are open, persistence can only be enabled in one tab at a time
//            } else if (err.code == 'unimplemented') {
//                // The current browser does not support all of the features required to enable persistence
//            }
//        });

        var uid = "id"

            // login anonymous user
          firebase.auth().signInAnonymously().catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
        });

            firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            // User is signed in.
            var isAnonymous = user.isAnonymous;
            var uid = user.uid;
            // ...
          } else {
            // User is signed out.
            // ...
          }
          // ...
        });

//

//    firebase.auth().signInAnonymously().catch(function(error) {
//                            // Handle Errors here.
//                            var errorCode = error.code;
//                            var errorMessage = error.message;
//                            console.log(errorMessage);
//                            // ...
//                        });

//        // When signed in, get the user ID
//        firebase.auth().onAuthStateChanged(function(user) {
//                                if (user) {
//                                    console.log("logged in");
//                                    var uid = user.uid;
//                                    console.log('Signed in as ' + uid)
//                                    } else {
//            // No user is signed in.
//          }});


//        if (uid !== null && uid !== undefined){
//            console.log(uid)
//        }else{
//            console.log("stringfailure")
//        };
//

        //Create reference to the database
//        var db = firebase.firestore();

        //Create a document in `db ` for the current participant
//        db.collection("Test").doc("TestDoc").collection("TestPart").doc(uid).set({
////            participantID: participantID, // Refers to the participant's ID from Prolific
//            date: new Date().toLocaleDateString(),
//            time: new Date().toLocaleTimeString()
//        });

//        db.collection("Tasks").doc("mi-game").collection("participants").doc(uid).set({
//                    date: new Date().toLocaleDateString(),
//                    time: new Date().toLocaleTimeString()
//                });


    //Updating an existing field: (an example)
       //db.collection("Tasks").doc('mi-game').collection('participants').doc(uid).update({
       //total_points: number_of_points
       //}); -->

        </script>

        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-survey-likert.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
        <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">
        </link>
    </head>
    <body></body>


<script>

        // Define Stimuli
        var balance = jsPsych.randomization.sampleWithReplacement([1, 0], 1)

        var pM = jsPsych.randomization.sampleWithoutReplacement([2, 3, 4, 5, 6, 7, 8], 2)

        var pEM = jsPsych.randomization.sampleWithoutReplacement([6, 7, 8, 9, 10], 2)

        var MI_Order = jsPsych.randomization.sampleWithoutReplacement([0, 1, 2, 3], 1)

        var turkID = jsPsych.data.getURLVariable('subject')

        jsPsych.data.addProperties({
            Pr_M: pM,
            Pr_EM: pEM,
            Color_Order: balance,
            Condition_Order: MI_Order,
            SubjectID: turkID,
        });

        if (pEM[0] == 6){
            pHit_M1   = "60%"
            pMiss_M1   = "40%"
        } else if (pEM[0] == 7){
            pHit_M1   = "70%"
            pMiss_M1   = "30%"
        } else if (pEM[0] == 8){
            pHit_M1   = "80%"
            pMiss_M1   = "20%"
        } else if (pEM[0] == 9){
            pHit_M1   = "90%"
            pMiss_M1   = "10%"
        } else if (pEM[0] == 10){
            pHit_M1   = "100%"
            pMiss_M1   = "0%"
        }

        if (pEM[1] == 6){
            pHit_M2   = "60%"
            pMiss_M2   = "40%"
        } else if (pEM[1] == 7){
            pHit_M2   = "70%"
            pMiss_M2   = "30%"
        } else if (pEM[1] == 8){
            pHit_M2   = "80%"
            pMiss_M2   = "20%"
        } else if (pEM[1] == 9){
            pHit_M2   = "90%"
            pMiss_M2   = "10%"
        } else if (pEM[1] == 10){
            pHit_M2   = "100%"
            pMiss_M2   = "0%"
        }

        if(balance == 1){
            R1Color      = "#35AA0F"
            R1ColorWord  = "<span class='a-span'>green</span>"
            R1Span       = "<span class='a-span'>Green Game</span>"
            R1BestOdds   = "<span class='a-span'>"+pHit_M1+"</span>"
            R1WorstOdds  = "<span class='a-span'>"+pMiss_M1+"</span>"
            R2Color      = "#339EFF"
            R2ColorWord  = "<span class='b-span'>blue</span>"
            R2Span       = "<span class='b-span'>Blue Game</span>"
            R2BestOdds   = "<span class='b-span'>"+pHit_M2+"</span>"
            R2WorstOdds  = "<span class='b-span'>"+pMiss_M2+"</span>"
        } else {
            R1Color      = "#339EFF"
            R1ColorWord  = "<span class='b-span'>blue</span>"
            R1Span       = "<span class='b-span'>Blue Game</span>"
            R1BestOdds   = "<span class='b-span'>"+pHit_M1+"</span>"
            R1WorstOdds  = "<span class='b-span'>"+pMiss_M1+"</span>"
            R2Color      = "#35AA0F"
            R2ColorWord  = "<span class='a-span'>green</span>"
            R2Span       = "<span class='a-span'>Green Game</span>"
            R2BestOdds   = "<span class='a-span'>"+pHit_M2+"</span>"
            R2WorstOdds  = "<span class='a-span'>"+pMiss_M2+"</span>"
        }

        if (pM[0] < pM[1]){
            SpeedChng1   = "more"
            SpeedChng2   = "you won't have to respond as fast"
        } else if (pM[0] > pM[1]){
            SpeedChng1  = "less"
            SpeedChng2  = "you'll have to respond faster"
        }

        var hit100_0 = jsPsych.randomization.shuffle([
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>"
            ])

        var hit90_10 = jsPsych.randomization.shuffle([
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>"
            ])

        var hit80_20 = jsPsych.randomization.shuffle([
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>"
            ])

        var hit70_30 = jsPsych.randomization.shuffle([
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>"
            ])

        var hit60_40 = jsPsych.randomization.shuffle([
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/jackpot.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            ])

        var miss100_0 = jsPsych.randomization.shuffle([
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            ])

        var miss90_10 = jsPsych.randomization.shuffle([
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            ])

        var miss80_20 = jsPsych.randomization.shuffle([
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            ])

        var miss70_30 = jsPsych.randomization.shuffle([
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            ])

        var miss60_40 = jsPsych.randomization.shuffle([
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/nope.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            "<img src='img/nope.png' class='rewardimg'>", "<img src='img/jackpot.png' class='rewardimg'>",
            ])

        var pM80 = jsPsych.randomization.shuffle([
            250, 250, 750, 750, 750, 750, 750, 750, 750, 750,
            ])

        var pM70 = jsPsych.randomization.shuffle([
            250, 250, 250, 750, 750, 750, 750, 750, 750, 750,
            ])

        var pM60 = jsPsych.randomization.shuffle([
            250, 250, 250, 250, 750, 750, 750, 750, 750, 750,
            ])

        var pM50 = jsPsych.randomization.shuffle([
            250, 250, 250, 250, 250, 750, 750, 750, 750, 750,
            ])

        var pM40 = jsPsych.randomization.shuffle([
            250, 250, 250, 250, 250, 250, 750, 750, 750, 750,
            ])

        var pM30 = jsPsych.randomization.shuffle([
            250, 250, 250, 250, 250, 250, 250, 750, 750, 750,
            ])

        var pM20 = jsPsych.randomization.shuffle([
            250, 250, 250, 250, 250, 250, 250, 250, 750, 750,
            ])

        var ITI = [250, 500, 750, 1000, 1250, 1500]

        var hits = -1

        var misses = -1

        var tNum = -1


        /* create timeline */
        var timeline = []

        /* define welcome message trial */
        var welcome = {
            type: "html-keyboard-response",
            stimulus: "This is where you will play the games. Press any key to begin."
        }

        var R1Intro = [
        "<div class='parent' style='text-align: left'>"
        +'<p>We are designing games for MTurk Workers. To help us '
        +"make the games fun and engaging, we are getting feedback from people like you.</p>"
        +"<p>You will play two different games: "
        +"the "+R1Span+" and the "+R2Span+". Then you will tell us "
        +"which you found more enjoyable.</p>"
        +"<p>The games are very similar, but their color schemes will help you tell them apart.</p>"
        +"<p>Continue to learn about and play the "+R1Span+".</p>"
        +"<p>After you finish, you will learn about and play the "+R2Span+".</p>"
        +"</div>",
        "<div class='parent'>"
        +'<p>The goal of the '+R1Span+' is to win as many "Jackpots" as possible.'
        +'<br>To win Jackpots, you will try to "activate" tiles like this one:</p>'
        +'<div class="box" style="background-color:gray"></div>'
        +"</div>",
        "<div class='parent'>"
        +"<p>The tiles will appear and disappear very quickly. "
        +"To activate a tile, you must press your SPACE BAR before it disappears. "
        +"Thus, whenever you see a tile, you should press your SPACE BAR as fast as possible.</p>"
        +'<div class="box" style="background-color:gray"></div>'
        +"</div>",
        "<div class='parent'>"
        +"<p>In the "+R1Span+", tiles turn "+R1ColorWord+" if activated.</p>"
        +'<div class="box" style="background-color:'+R1Color+'"></div>'
        +"</div>",
        "<div class='parent'>"
        +"<p>If you turn a tile "+R1ColorWord+", "
        +"your odds of winning a Jackpot that round are "+R1BestOdds+".</p>"
        +'<div class="box" style="background-color:'+R1Span+'"></div>'
        +"</div>",
        "<div class='parent'>"
        +'<p>If a tile disappears before you turn it '+R1ColorWord+', '
        +"your odds of winning a Jackpot that round are "+R1WorstOdds+".</p>"
        +"</div>",
        "<div class='parent'>"
        +"<p>If you win a Jackpot, you'll see this image...</p>"
        +"<img src='img/jackpot.png', style='height: 75%'>"
        +"</div>",
        "<div class='parent'>"
        +"<p>..and if you don't win a Jackpot, you'll see this image.</p>"
        +"<img src='img/nope.png', style='height: 75%'>"
        +"</div>",
        "<div class='parent'>"
        +"<p>If you have read and understood the instructions, please continue to play the "+R1Span+"."
        +"<br>To re-read any of the instructions, press the 'previous' button to navigate back.</p>"
        +"</div>"]

        // LoMI to HiMI Instructions
        var R2Intro = [
        "<div class='parent'>"
        +"<p>Thank you for playing the "+R1Span+"!</p>"
        +"When you're ready, continue to learn about and play the "+R2Span+".</p>"
        +"</div>",
        "<div class='parent'>"
        +"<p>The "+R2Span+" is identical to the "+R1Span+" with three exceptions.</p>"
        +"</div>",
        "<div class='parent'>"
        +"<p>First, in the "+R2Span+", tiles turn "+R2ColorWord+" if activated.</p>"
        +'<div class="box" style="background-color:'+R2Color+'"></div>'
        +"</div>",
        "<div class='parent'>"
        +"<p>Second, in the "+R2Span+", if you turn a tile "+R2ColorWord+", "
        +"<br>your odds of winning a Jackpot that round are "+R2BestOdds+" (instead of "+R1BestOdds+")...</p>"
        +'<div class="box" style="background-color:'+R2Color+'"></div>'
        +"</div>",
        "<div class='parent'>"
        +'<p>...and if a tile disappears before you turn it '+R2ColorWord+', '
        +"<br>your odds of winning a Jackpot that round are "+R2WorstOdds+" (instead of "+R1WorstOdds+").</p>"
        +"</div>",
         "<div class='parent'>"
        +"<p>Finally, in the "+R2Span+", you'll have "+SpeedChng1+" time to activate the tiles."
        +"<br>Thus, in the "+R2Span+", "+SpeedChng2+".</p>"
        +'<div class="box" style="background-color:'+R2Color+'"></div>'
        +"</div>",
        "<div class='parent'>"
        +"<p>If you have read and understood the instructions, please continue to play the "+R2Span+"."
        +"<br>To re-read any of the instructions, press the 'previous' button to navigate back.</p>"
        +"</div>"]



        var T1 = {
            type: "instructions",
            pages: R1Intro,
            show_clickable_nav: true,
            post_trial_gap: 500,
            on_start: function(){

            }
        }

        var T2 = {
            type: "instructions",
            pages: R2Intro,
            show_clickable_nav: true,
            post_trial_gap: 500,
            on_finish: function(){
                hits = -1;
                misses = -1;
                tNum = -1;
            }
        }

        timeline.push(welcome)


        // Create Trials

        var Delay = {
            type: 'html-keyboard-response',
            data: {Trial_Type: 'ITI'},
            stimulus: "",
            choices: [32],
            trial_duration: function(){
                return jsPsych.randomization.sampleWithoutReplacement(ITI, 1)[0];
            },
            on_finish: function(data){
                if(data.key_press == 32){
                    data.TooFast = 1;
                    tNum = tNum + 1;
                } else {
                    data.TooFast = 0;
                    tNum = tNum + 1;
                }
            },
        }

        var TooFast = {
            type: 'html-keyboard-response',
            data: {Trial_Type: 'Too_Fast_Message'},
            stimulus: function(){
                if(jsPsych.data.get().last(1).values()[0].key_press == 32){
                    return "<div style='font-size: 20px'><p>Too Fast!</p>"+
                    "<p>Please wait for the tile to appear before pressing your SPACEBAR</p></div>"
                } else {
                    return ""
                }
            },
            trial_duration: function(){
                if(jsPsych.data.get().last(1).values()[0].key_press == 32){
                    return 2500
                } else {
                    return 0
                }
            },
            post_trial_gap: function(){
                if(jsPsych.data.get().last(1).values()[0].key_press == 32){
                    return 1000;
                } else {
                    return 0
                }
            },
            choices: jsPsych.NO_KEYS,
        }

        var R1_Probe = {
            type: 'html-keyboard-response',
            data: {Trial_Type: 'Probe'},
            stimulus: '<div class="box" style="background-color:gray"></div>',
            choices: [32],
            trial_duration: function(){
                if(pM[0] == 8){
                    return pM80[tNum];
                } else if(pM[0] == 7){
                    return pM70[tNum];
                } else if(pM[0] == 6){
                    return pM60[tNum];
                } else if(pM[0] == 5){
                    return pM50[tNum];
                } else if(pM[0] == 4){
                    return pM40[tNum];
                } else if(pM[0] == 3){
                    return pM30[tNum];
                } else if(pM[0] == 2){
                    return pM20[tNum];
                }
            },
            on_finish: function(data){
                if(data.key_press == 32 && tNum < 9){
                    data.TooSlow = 0;
                } else if(data.key_press != 32 && tNum < 9){
                    data.TooSlow = 1;
                } else if(data.key_press == 32 && tNum == 9){
                    data.TooSlow = 0;
                    tNum = -1;
                    pM80 = jsPsych.randomization.shuffle(pM80);
                    pM70 = jsPsych.randomization.shuffle(pM70);
                    pM60 = jsPsych.randomization.shuffle(pM60);
                    pM50 = jsPsych.randomization.shuffle(pM50);
                    pM40 = jsPsych.randomization.shuffle(pM40);
                    pM30 = jsPsych.randomization.shuffle(pM30);
                    pM20 = jsPsych.randomization.shuffle(pM20);
                } else if(data.key_press != 32 && tNum == 9){
                    data.TooSlow = 1;
                    tNum = -1;
                    pM80 = jsPsych.randomization.shuffle(pM80);
                    pM70 = jsPsych.randomization.shuffle(pM70);
                    pM60 = jsPsych.randomization.shuffle(pM60);
                    pM50 = jsPsych.randomization.shuffle(pM50);
                    pM40 = jsPsych.randomization.shuffle(pM40);
                    pM30 = jsPsych.randomization.shuffle(pM30);
                    pM20 = jsPsych.randomization.shuffle(pM20);
                }
            },
        }

        var R2_Probe = {
            type: 'html-keyboard-response',
            data: {Trial_Type: 'Probe'},
            stimulus: '<div class="box" style="background-color:gray"></div>',
            choices: [32],
            trial_duration: function(){
                if(pM[1] == 8){
                    return pM80[tNum];
                } else if(pM[1] == 7){
                    return pM70[tNum];
                } else if(pM[1] == 6){
                    return pM60[tNum];
                } else if(pM[1] == 5){
                    return pM50[tNum];
                } else if(pM[1] == 4){
                    return pM40[tNum];
                } else if(pM[1] == 3){
                    return pM30[tNum];
                } else if(pM[1] == 2){
                    return pM20[tNum];
                }
            },
            on_finish: function(data){
                if(data.key_press == 32 && tNum < 9){
                    data.TooSlow = 0;
                } else if(data.key_press != 32 && tNum < 9){
                    data.TooSlow = 1;
                } else if (data.key_press == 32 && tNum == 9){
                    data.TooSlow = 0;
                    tNum = -1;
                    pM80 = jsPsych.randomization.shuffle(pM80);
                    pM70 = jsPsych.randomization.shuffle(pM70);
                    pM60 = jsPsych.randomization.shuffle(pM60);
                    pM50 = jsPsych.randomization.shuffle(pM50);
                    pM40 = jsPsych.randomization.shuffle(pM40);
                    pM30 = jsPsych.randomization.shuffle(pM30);
                    pM20 = jsPsych.randomization.shuffle(pM20);
                } else if (data.key_press != 32 && tNum == 9){
                    data.TooSlow = 1;
                    tNum = -1;
                    pM80 = jsPsych.randomization.shuffle(pM80);
                    pM70 = jsPsych.randomization.shuffle(pM70);
                    pM60 = jsPsych.randomization.shuffle(pM60);
                    pM50 = jsPsych.randomization.shuffle(pM50);
                    pM40 = jsPsych.randomization.shuffle(pM40);
                    pM30 = jsPsych.randomization.shuffle(pM30);
                    pM20 = jsPsych.randomization.shuffle(pM20);
                }
            },
        }

        var Response_R1 = {
            type: 'html-keyboard-response',
            data: {Trial_Type: 'Activation_R1'},
            stimulus: function(){
                if(jsPsych.data.get().last(1).values()[0].key_press == 32){
                    return '<div class="box" style="background-color:'+R1Color+'"> </div>'
                } else {
                    return '<div class="box" style="background-color:white"> </div>'
                }
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: 800,
            on_finish: function(){
                if (jsPsych.data.get().last(2).values()[0].key_press != 32 && misses < 9){
                    misses = misses + 1;
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && hits < 9){
                    hits = hits + 1;
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32){
                    hits = 0;
                    hit100_0 = jsPsych.randomization.shuffle(hit100_0);
                    hit90_10 = jsPsych.randomization.shuffle(hit90_10);
                    hit80_20 = jsPsych.randomization.shuffle(hit80_20);
                    hit70_30 = jsPsych.randomization.shuffle(hit70_30);
                    hit60_40 = jsPsych.randomization.shuffle(hit60_40);
                } else {
                    misses = 0;
                    miss100_0 = jsPsych.randomization.shuffle(miss100_0);
                    miss90_10 = jsPsych.randomization.shuffle(miss90_10);
                    miss80_20 = jsPsych.randomization.shuffle(miss80_20);
                    miss70_30 = jsPsych.randomization.shuffle(miss70_30);
                    miss60_40 = jsPsych.randomization.shuffle(miss60_40);
                }
            },
        }

        var Response_R2 = {
            type: 'html-keyboard-response',
            data: {Trial_Type: 'Activation_R2'},
            stimulus: function(){
                if(jsPsych.data.get().last(1).values()[0].key_press == 32){
                    return '<div class="box" style="background-color:'+R2Color+'"> </div>'
                } else {
                    return '<div class="box" style="background-color:white"> </div>'
                }
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: 800,
            on_finish: function(){
                if (jsPsych.data.get().last(2).values()[0].key_press != 32 && misses < 9){
                    misses = misses + 1;
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && hits < 9){
                    hits = hits + 1;
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32){
                    hits = 0;
                    hit100_0 = jsPsych.randomization.shuffle(hit100_0);
                    hit90_10 = jsPsych.randomization.shuffle(hit90_10);
                    hit80_20 = jsPsych.randomization.shuffle(hit80_20);
                    hit70_30 = jsPsych.randomization.shuffle(hit70_30);
                    hit60_40 = jsPsych.randomization.shuffle(hit60_40);
                } else {
                    misses = 0;
                    miss100_0 = jsPsych.randomization.shuffle(miss100_0);
                    miss90_10 = jsPsych.randomization.shuffle(miss90_10);
                    miss80_20 = jsPsych.randomization.shuffle(miss80_20);
                    miss70_30 = jsPsych.randomization.shuffle(miss70_30);
                    miss60_40 = jsPsych.randomization.shuffle(miss60_40);
                }
            },
        }

        var Feedback_R1 = {
            type: 'html-keyboard-response',
            data: {Trial_Type: 'Feedback_R1'},
            stimulus: function(){
                if(jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[0] == 10){
                    return hit100_0[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[0] == 10){
                    return miss100_0[misses];
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[0] == 9){
                    return hit90_10[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[0] == 9){
                    return miss90_10[misses];
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[0] == 8){
                    return hit80_20[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[0] == 8){
                    return miss80_20[misses];
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[0] == 7){
                    return hit70_30[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[0] == 7){
                    return miss70_30[misses];
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[0] == 6){
                    return hit60_40[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[0] == 6){
                    return miss60_40[misses];
                }
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: 800,
        }

        var Feedback_R2 = {
            type: 'html-keyboard-response',
            data: {Trial_Type: 'Feedback_R2'},
            stimulus: function(){
                if(jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[1] == 10){
                    return hit100_0[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[1] == 10){
                    return miss100_0[misses];
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[1] == 9){
                    return hit90_10[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[1] == 9){
                    return miss90_10[misses];
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[1] == 8){
                    return hit80_20[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[1] == 8){
                    return miss80_20[misses];
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[1] == 7){
                    return hit70_30[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[1] == 7){
                    return miss70_30[misses];
                } else if (jsPsych.data.get().last(2).values()[0].key_press == 32 && pEM[1] == 6){
                    return hit60_40[hits];
                } else if (jsPsych.data.get().last(2).values()[0].key_press != 32 && pEM[1] == 6){
                    return miss60_40[misses];
                }
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: 800,
        }

        var R1_Procedure = {
            timeline: [Delay, TooFast, R1_Probe, Response_R1, Feedback_R1],
            repetitions: 50,
        }

        var R2_Procedure = {
            timeline: [Delay, TooFast, R2_Probe, Response_R2, Feedback_R2],
            repetitions: 50,
        }

        var scale_1 = [
            "-4<font size='2'><br>Completely<br>Disagree</font>",
            "-3<font size='2'><br>Strongly<br>Disagree</font>",
            "-2<font size='2'><br>Moderately<br>Disagree</font>",
            "-1<font size='2'><br>Slightly<br>Disagree</font>",
            "0<font size='2'><br>Neither Agree Nor Disagree</font>",
            "1<font size='2'><br>Slightly<br>Agree</font>",
            "2<font size='2'><br>Moderately<br>Agree</font>",
            "3<font size='2'><br>Strongly<br>Agree</font>",
            "4<font size='2'><br>Completely<br>Agree</font>",
        ];

        var scale_2 = [
            "0<font size='2'><br>Zero<br>Control</font>",
            "1", "2", "3", "4", "5", "6", "7",
            "8<font size='2'><br>Complete<br>Control</font>",
        ];

        var scale_3 = [
            "-4<font size='2'><br>Way<br>Too Easy</font>",
            "-3",
            "-2",
            "-1",
            "0<font size='2'><br>Just Right</font>",
            "1",
            "2",
            "3",
            "4<font size='2'><br>Way<br>Too Hard</font>",
        ];

        var R1a_DVs = {
            type: 'survey-likert',
            preamble:
                '<div style="padding-top: 50px; width: 800px; font-size:16px">'
                +'<p>Thank you for playing the '+R1Span+'!</p>'
                +'<p>Now, please indicate the extent to which you agree or disagree with each of the following statements.</p></div>',
            questions: [
                {prompt: '"While playing the '+R1Span+', I felt absorbed in what I was doing."',
                name: 'R1_Absorbed',
                labels: scale_1},
                {prompt: '"While playing the '+R1Span+', I felt immersed in what I was doing."',
                name: 'R1_Immersed',
                labels: scale_1},
                {prompt: '"While playing the '+R1Span+', I felt engaged in what I was doing."',
                name: 'R1_Engaged',
                labels: scale_1},
                {prompt: '"I found it hard to stay focused on the '+R1Span+'."',
                name: 'R1_HardToFocus',
                labels: scale_1},
                {prompt: '"I kept wondering when the '+R1Span+' would end."',
                name: 'R1_WhenEnd',
                labels: scale_1},
                {prompt: '"Playing the '+R1Span+' was addictive."',
                name: 'R1_Addictive',
                labels: scale_1},
                {prompt: '"I felt like the '+R1Span+' took a long time to finish."',
                name: 'R1_LongTime',
                labels: scale_1},
            ],
            randomize_question_order: true,
            scale_width: 750
        };

        var R1b_DVs = {
            type: 'survey-likert',
            preamble:
                '<div style="padding-top: 50px; width: 800px; font-size:16px">'
                +'<p>Please answer two more questions about the '+R1Span+'.</p></div>',
            questions: [
                {prompt: 'While playing the '+R1Span+', how much control did you feel you had over the outcome of each trial?',
                name: 'R1_Control',
                labels: scale_2},
                {prompt: 'Was the '+R1Span+' too easy, too hard, or just the right level of difficulty?',
                name: 'R1_Balance',
                labels: scale_3},
            ],
            randomize_question_order: true,
            scale_width: 750
        };

        var R2a_DVs = {
            type: 'survey-likert',
            preamble:
                '<div style="padding-top: 50px; width: 800px; font-size:16px">'
                +'<p>Thank you for playing the '+R2Span+'!</p>'
                +'<p>Now, please indicate the extent to which you agree or disagree with each of the following statements.</p></div>',
            questions: [
                {prompt: '"While playing the '+R2Span+', I felt absorbed in what I was doing."',
                name: 'R2_Absorbed',
                labels: scale_1},
                {prompt: '"While playing the '+R2Span+', I felt immersed in what I was doing."',
                name: 'R2_Focused',
                labels: scale_1},
                {prompt: '"While playing the '+R2Span+', I felt engaged in what I was doing."',
                name: 'R2_Engaged',
                labels: scale_1},
                {prompt: '"I found it hard to stay focused on the '+R2Span+'."',
                name: 'R2_HardToFocus',
                labels: scale_1},
                {prompt: '"I kept wondering when the '+R2Span+' would end."',
                name: 'R2_WhenEnd',
                labels: scale_1},
                {prompt: '"Playing the '+R2Span+' was addictive."',
                name: 'R2_Addictive',
                labels: scale_1},
                {prompt: '"I felt like the '+R2Span+' took a long time to finish."',
                name: 'R2_LongTime',
                labels: scale_1},
            ],
            randomize_question_order: true,
            scale_width: 750
        };

        var R2b_DVs = {
            type: 'survey-likert',
            preamble:
                '<div style="padding-top: 50px; width: 800px; font-size:16px">'
                +'<p>Please answer two more questions about the '+R2Span+'!</p></div>',
            questions: [
                {prompt: 'While playing the '+R2Span+', how much control did you feel you had over the outcome of each trial?',
                name: 'R2_Control',
                labels: scale_2},
                {prompt: 'Was the '+R2Span+' too easy, too hard, or just the right level of difficulty?',
                name: 'R2_Balance',
                labels: scale_3},
            ],
            randomize_question_order: true,
            scale_width: 750
        };

        var test_procedure = {
            timeline: [T1, R1_Procedure, R1a_DVs, R1b_DVs, T2, R2_Procedure, R2a_DVs, R2b_DVs],
            }

//    	/* start the experiment */
//    	jsPsych.init({
//    		timeline: timeline
//    	});

//        function saveData(name, data){
//          var xhr = new XMLHttpRequest();
//          xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
//          xhr.setRequestHeader('Content-Type', 'application/json');
//          xhr.send(JSON.stringify({filename: name, filedata: data}));
//        }

        timeline.push(test_procedure)

        // call the saveData function after the experiment is over
        jsPsych.init({
            timeline: timeline,
            on_finish: function(){
                window.location.replace("https://yalesurvey.ca1.qualtrics.com/jfe/form/SV_cINZ0RNEg9J4ocd?workerId="+turkID);
            },
            on_close: function() {
                firebase.database().ref(firebase.auth().currentUser.uid).set({
                    data: jsPsych.data.get().values()
                });
            },
        });
    </script>

<!--
    <script>
        db.collection("tasks").doc('new_task').collection('subjects').doc(uid).update({
            date: new Date().toLocaleDateString(),
            time: new Date().toLocaleTimeString()
        });
    </script>
-->

</html>
